<div *ngIf="showPrevArrow" class="prev" (click)="prev()">
  <doe-chevron-icon
    *ngIf="!arrowTemplate; else arrowTemplate"
  ></doe-chevron-icon>
</div>

<ul #itemList [attr.aria-label]="aria?.viewerLabel">
  <li *ngIf="!items?.length" class="initial-item"></li>
  <li
    #items
    *ngFor="let item of items; let i = index"
    [class.selected]="i === selectedIndex"
    tabindex="0"
    [attr.aria-label]="item.alt"
    [attr.aria-describedby]="'imgr-desc-' + i"
    (click)="onImageClick(i, item, $event)"
    (dragstart)="onDragstart($event)"
    (keydown.Tab)="onTab(i + 1)"
    (keydown.shift.Tab)="onTab(i - 1)"
  >
    <ng-container *ngIf="!itemTemplate; else customTemplate">
      <ng-container *ngIf="!UA.ios || isInScrollportProximity(i)">
        <ng-container *ngIf="getSrc(item); let src">
          <picture *ngIf="toImage(item) as image" @remove>
            <source
              *ngFor="let source of image.pictureSources"
              [srcset]="source.srcset"
              [attr.media]="source.media"
              [attr.sizes]="source.sizes"
              [attr.type]="source.type"
            />
            <img
              [src]="src"
              [alt]="item.alt"
              [class.loading]="item._seen && !item._loaded"
              [style.objectFit]="objectFit"
              (load)="onItemLoaded(item, $event)"
              (error)="onItemErrored(item, $event)"
            />
          </picture>
          <!-- Using loadedmetadata instead of loadeddata because iOS loads data lazily upon user's interaction -->
          <video
            @remove
            *ngIf="!isYoutube(item) && isVideo(i)"
            [src]="src"
            [poster]="item.thumbSrc"
            [class.loading]="item._seen && !item._loaded"
            [style.objectFit]="objectFit"
            controls
            playsinline
            (loadedmetadata)="onItemLoaded(item, $event)"
            (error)="onItemErrored(item, $event)"
          ></video>

          <iframe
            @remove
            *ngIf="isYoutube(item)"
            [src]="src | safe"
            frameborder="0"
            allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            (load)="onItemLoaded(item, $event)"
          ></iframe>
        </ng-container>
      </ng-container>

      <ng-container *ngIf="item._seen && !item._loaded && !item._failed">
        <ng-container *ngTemplateOutlet="loadingTemplate"></ng-container>
      </ng-container>

      <ng-container *ngIf="item._failed">
        <div *ngIf="!errorTemplate; else errorTemplate" class="error">
          <div class="icon">âš </div>
          <p class="text">
            {{ errorText || 'Loading of this media failed' }}
          </p>
        </div>
      </ng-container>
    </ng-container>

    <span
      [id]="'imgr-desc-' + i"
      class="aria-description"
      [innerHTML]="item.description"
      aria-hidden="true"
    ></span>

    <ng-template #customTemplate>
      <ng-container
        *ngTemplateOutlet="
          itemTemplate;
          context: {
            index: i,
            selectedIndex: selectedIndex,
            item: item,
            seen: item._seen
          }
        "
      ></ng-container>
    </ng-template>
  </li>
</ul>

<div *ngIf="showNextArrow" class="next" (click)="next()">
  <doe-chevron-icon
    *ngIf="!arrowTemplate; else arrowTemplate"
  ></doe-chevron-icon>
</div>

<doe-counter
  *ngIf="imageCounter && items?.length"
  [itemQuantity]="items?.length"
  [selectedIndex]="selectedIndex"
  [orientation]="imageCounterOrientation"
></doe-counter>

<div
  *ngIf="descriptions && items"
  class="description-container"
  [class.above-counter]="imageCounterOrientation === 'bottom'"
  aria-hidden="true"
>
  <div
    *ngIf="items[selectedIndex]?.description as description"
    class="description"
    [innerHTML]="description"
    (click)="descriptionClick.emit($event)"
  ></div>
</div>
